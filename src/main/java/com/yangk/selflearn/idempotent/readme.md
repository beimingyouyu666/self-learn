## 利用redis实现接口幂等性

美团的GTIS
### 实际流程

1、进入页面先获取一个uuid生成的token

2、提交时，从request中取出token，如果request中没携带token则直接抛异常不允许请求

3、直接删除token，判断删除返回结果

4、删除成功则说明校验通过，删除失败则说明不通过，抛异常


### 保证幂等性的方法
1.建立唯一索引，防止新增脏数据
这个可以限制重复插入数据，当重复时，数据库会抛异常，保证不会出现脏数据。但体验不好，并且实用场景有限制。

2.利用 token 机制，防止页面重复提交
核心思想是为每一次操作生成一个唯一性的凭证，也就是token。一个token在操作的每一个阶段只有一次执行权，一旦执行成功则保存执行结果。对重复的请求，返回同一个结果。

3.状态机幂等
在有状态的数据中可以使用，如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。如果状态是顺序的，不可逆，那么就不会出现 ABA 问题，否则会出现 ABA问题。

4.悲观锁 -- 获取数据的时候加锁(锁表或锁行)

  乐观锁 -- 基于版本号version实现, 在更新数据那一刻校验数据
  
5.分布式锁
在进入方法时，先去获取锁，假如获取到锁，就继续后面的流程。假如没有获取到锁，就等待锁的释放直到获取到锁。当执行完方法时，释放锁。当然，锁要设个超时时间，防止意外没有释放到锁。它用来解决分布式系统的幂等性，常用的实现方案是 redis 和 zookeeper 等工具。

6.对外提供幂等的接口
通过 source来源+seq序列号来判断请求是否重复， 在并发时只能处理一个请求。其它相同并发请求要么返回请求重复，要么等待前面请求执行完成在执行。

### 幂等性的不足
1.增加了额外控制幂等的业务逻辑，复杂化了业务功能。
2.把并行执行的功能改为串行执行，降低了执行效率。